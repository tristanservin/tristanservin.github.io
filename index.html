<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro por QR</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 0 12px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 820px) { .row { grid-template-columns: 1fr 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    label { display:block; margin: 10px 0 6px; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .btn { background:#0b5; color:#fff; }
    .btn2 { background:#06c; color:#fff; }
    .btn3 { background:#666; color:#fff; }
    .warn { background:#ffe9a8; padding: 10px; border-radius: 10px; }
    .ok { background:#d8ffd8; padding: 10px; border-radius: 10px; }
    .err { background:#ffd8d8; padding: 10px; border-radius: 10px; }
    .muted { color:#666; font-size: .92rem; }
    code { background:#f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>

  <!-- Librer√≠a para escanear QR (c√°mara) -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <h1>üì¶ Registro y Recepci√≥n por QR</h1>
  <p class="muted">
    Flujo: <b>Escanear QR</b> ‚Üí llenar datos ‚Üí <b>Guardar</b>.  
    En llegada: <b>Escanear QR</b> ‚Üí <b>Marcar recibido</b>.
  </p>

  <div class="row">
    <div class="card">
      <h2>1) Escanear QR</h2>
      <p class="muted">Permite c√°mara. En GitHub Pages funciona (HTTPS).</p>

      <div id="reader" style="width:100%;"></div>

      <p><b>QR detectado:</b> <code id="qrText">‚Äî</code></p>

      <div style="display:flex; gap:10px; flex-wrap: wrap;">
        <button class="btn3" id="startBtn">Iniciar c√°mara</button>
        <button class="btn3" id="stopBtn" disabled>Detener</button>
        <button class="btn2" id="buscarBtn" disabled>Buscar registro</button>
      </div>

      <p id="scanMsg" class="muted"></p>
    </div>

    <div class="card">
      <h2>2) Datos del env√≠o</h2>

      <div class="warn">
        Este demo guarda en el navegador (localStorage).  
        Si borras datos del navegador o cambias de dispositivo, se pierde.
      </div>

      <form id="formEnvio">
        <label for="vivienda">Vivienda (ej. Casa 12 / Dept 3B)</label>
        <input id="vivienda" required placeholder="Ej: Casa 12" />

        <label for="producto">Producto</label>
        <input id="producto" required placeholder="Ej: Cemento 50kg" />

        <label for="destino">¬øPara d√≥nde va?</label>
        <input id="destino" required placeholder="Ej: Bodega Norte / Obra X" />

        <label for="nota">Nota (opcional)</label>
        <textarea id="nota" rows="3" placeholder="Detalles extra..."></textarea>

        <div style="display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap;">
          <button type="submit" class="btn" id="guardarBtn" disabled>Guardar env√≠o</button>
          <button type="button" class="btn2" id="recibidoBtn" disabled>Marcar como recibido</button>
          <button type="button" class="btn3" id="limpiarBtn">Limpiar</button>
        </div>
      </form>

      <div id="estadoBox" style="margin-top:12px;"></div>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <h2>üìã Registros guardados (este dispositivo)</h2>
    <button class="btn3" id="refrescarLista">Refrescar lista</button>
    <button class="btn3" id="borrarTodo">Borrar todo</button>
    <div id="lista" style="margin-top: 10px;"></div>
  </div>

<script>
  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);

  function nowISO() {
    return new Date().toISOString();
  }

  function storageKey(qr) {
    return "envio:" + qr;
  }

  function setMsg(type, text) {
    const box = $("estadoBox");
    const cls = type === "ok" ? "ok" : type === "err" ? "err" : "warn";
    box.innerHTML = `<div class="${cls}">${text}</div>`;
  }

  function getCurrentQR() {
    return $("qrText").textContent && $("qrText").textContent !== "‚Äî"
      ? $("qrText").textContent
      : null;
  }

  function resetForm() {
    $("vivienda").value = "";
    $("producto").value = "";
    $("destino").value = "";
    $("nota").value = "";
    setMsg("warn", "Escanea un QR para empezar.");
    $("guardarBtn").disabled = true;
    $("buscarBtn").disabled = true;
    $("recibidoBtn").disabled = true;
  }

  // ===== QR Scanner =====
  let html5QrCode = null;

  function onScanSuccess(decodedText) {
    $("qrText").textContent = decodedText;
    $("guardarBtn").disabled = false;
    $("buscarBtn").disabled = false;

    // Intentar cargar si ya existe
    loadRecord(decodedText, true);
  }

  async function startScanner() {
    $("scanMsg").textContent = "Iniciando c√°mara...";
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        $("scanMsg").textContent = "No se detectaron c√°maras.";
        return;
      }

      $("startBtn").disabled = true;
      $("stopBtn").disabled = false;

      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
      );

      $("scanMsg").textContent = "C√°mara activa. Enfoca el QR.";
    } catch (err) {
      $("scanMsg").textContent = "Error al iniciar c√°mara: " + err;
      $("startBtn").disabled = false;
      $("stopBtn").disabled = true;
    }
  }

  async function stopScanner() {
    if (!html5QrCode) return;
    try {
      await html5QrCode.stop();
      await html5QrCode.clear();
      $("scanMsg").textContent = "C√°mara detenida.";
    } catch (e) {}
    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
  }

  // ===== Data logic =====
  function saveRecord(qr) {
    const record = {
      qr,
      vivienda: $("vivienda").value.trim(),
      producto: $("producto").value.trim(),
      destino: $("destino").value.trim(),
      nota: $("nota").value.trim(),
      creado_en: nowISO(),
      recibido: false,
      recibido_en: null
    };

    localStorage.setItem(storageKey(qr), JSON.stringify(record));
    setMsg("ok", `‚úÖ Guardado. QR: <code>${qr}</code>`);
    $("recibidoBtn").disabled = false;
    renderList();
  }

  function loadRecord(qr, silent = false) {
    const raw = localStorage.getItem(storageKey(qr));
    if (!raw) {
      if (!silent) setMsg("warn", `No hay registro para QR: <code>${qr}</code>. Llena datos y guarda.`);
      $("recibidoBtn").disabled = true;
      return null;
    }

    const record = JSON.parse(raw);
    $("vivienda").value = record.vivienda || "";
    $("producto").value = record.producto || "";
    $("destino").value = record.destino || "";
    $("nota").value = record.nota || "";

    $("recibidoBtn").disabled = false;

    if (!silent) {
      if (record.recibido) {
        setMsg("ok", `üì¶ Ya fue marcado como <b>recibido</b> el <code>${record.recibido_en}</code>.`);
      } else {
        setMsg("ok", `Encontrado. A√∫n no est√° recibido. Puedes marcarlo como recibido.`);
      }
    } else {
      // cuando escanea, no spamear demasiado, pero s√≠ habilitar bot√≥n
      if (record.recibido) {
        setMsg("ok", `üì¶ QR encontrado. Estado: <b>recibido</b> ‚úÖ`);
      } else {
        setMsg("warn", `QR encontrado. Estado: <b>pendiente</b> ‚è≥`);
      }
    }

    return record;
  }

  function markReceived(qr) {
    const rec = loadRecord(qr, true);
    if (!rec) {
      setMsg("err", `‚ùå No existe registro para QR: <code>${qr}</code>. Primero gu√°rdalo.`);
      return;
    }
    rec.recibido = true;
    rec.recibido_en = nowISO();
    localStorage.setItem(storageKey(qr), JSON.stringify(rec));
    setMsg("ok", `‚úÖ Marcado como recibido. Fecha: <code>${rec.recibido_en}</code>`);
    renderList();
  }

  function renderList() {
    const container = $("lista");
    const items = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith("envio:")) {
        const rec = JSON.parse(localStorage.getItem(k));
        items.push(rec);
      }
    }

    items.sort((a,b) => (b.creado_en || "").localeCompare(a.creado_en || ""));

    if (items.length === 0) {
      container.innerHTML = `<p class="muted">No hay registros guardados.</p>`;
      return;
    }

    container.innerHTML = items.map(r => `
      <div class="card" style="margin-top:10px;">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <b>QR:</b> <code>${r.qr}</code><br/>
            <b>Vivienda:</b> ${escapeHTML(r.vivienda)}<br/>
            <b>Producto:</b> ${escapeHTML(r.producto)}<br/>
            <b>Destino:</b> ${escapeHTML(r.destino)}<br/>
            <span class="muted">Creado: ${r.creado_en || "‚Äî"}</span>
          </div>
          <div>
            ${r.recibido
              ? `<div class="ok">Recibido ‚úÖ<br/><span class="muted">${r.recibido_en}</span></div>`
              : `<div class="warn">Pendiente ‚è≥</div>`
            }
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn2" onclick="window.__loadFromList('${encodeURIComponent(r.qr)}')">Cargar</button>
              <button class="btn" onclick="window.__receiveFromList('${encodeURIComponent(r.qr)}')">Recibido</button>
              <button class="btn3" onclick="window.__deleteFromList('${encodeURIComponent(r.qr)}')">Borrar</button>
            </div>
          </div>
        </div>
        ${r.nota ? `<p><b>Nota:</b> ${escapeHTML(r.nota)}</p>` : ""}
      </div>
    `).join("");
  }

  function escapeHTML(str) {
    return (str || "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // Exponer funciones para botones dentro del HTML generado
  window.__loadFromList = (qrEnc) => {
    const qr = decodeURIComponent(qrEnc);
    $("qrText").textContent = qr;
    $("guardarBtn").disabled = false;
    $("buscarBtn").disabled = false;
    loadRecord(qr, false);
  };
  window.__receiveFromList = (qrEnc) => markReceived(decodeURIComponent(qrEnc));
  window.__deleteFromList = (qrEnc) => {
    const qr = decodeURIComponent(qrEnc);
    localStorage.removeItem(storageKey(qr));
    setMsg("warn", `üóëÔ∏è Borrado registro QR: <code>${qr}</code>`);
    renderList();
  };

  // ===== Events =====
  $("startBtn").addEventListener("click", startScanner);
  $("stopBtn").addEventListener("click", stopScanner);

  $("buscarBtn").addEventListener("click", () => {
    const qr = getCurrentQR();
    if (!qr) return setMsg("warn", "Escanea un QR primero.");
    loadRecord(qr, false);
  });

  $("formEnvio").addEventListener("submit", (e) => {
    e.preventDefault();
    const qr = getCurrentQR();
    if (!qr) return setMsg("warn", "Escanea un QR primero.");

    // validaci√≥n simple
    if (!$("vivienda").value.trim() || !$("producto").value.trim() || !$("destino").value.trim()) {
      return setMsg("err", "‚ùå Completa vivienda, producto y destino.");
    }
    saveRecord(qr);
  });

  $("recibidoBtn").addEventListener("click", () => {
    const qr = getCurrentQR();
    if (!qr) return setMsg("warn", "Escanea un QR primero.");
    markReceived(qr);
  });

  $("limpiarBtn").addEventListener("click", () => {
    $("qrText").textContent = "‚Äî";
    resetForm();
  });

  $("refrescarLista").addEventListener("click", renderList);

  $("borrarTodo").addEventListener("click", () => {
    if (!confirm("¬øSeguro que quieres borrar TODOS los registros de este dispositivo?")) return;
    const keysToDelete = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith("envio:")) keysToDelete.push(k);
    }
    keysToDelete.forEach(k => localStorage.removeItem(k));
    setMsg("warn", "üóëÔ∏è Todo borrado.");
    renderList();
  });

  // Init
  resetForm();
  renderList();
</script>
</body>
</html>