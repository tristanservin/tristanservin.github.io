<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Inventario - Generar y Escanear</title>

  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 20px auto; padding: 0 12px; }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .tab { padding:10px 14px; border-radius: 999px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { border:1px solid #ddd; border-radius:14px; padding:14px; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; }
    button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; }
    .btn { background:#0b5; color:#fff; }
    .btn2 { background:#06c; color:#fff; }
    .btn3 { background:#666; color:#fff; }
    .muted { color:#666; font-size:.92rem; }
    .ok { background:#d8ffd8; padding:10px; border-radius:10px; }
    .warn { background:#ffe9a8; padding:10px; border-radius:10px; }
    .err { background:#ffd8d8; padding:10px; border-radius:10px; }
    code { background:#f2f2f2; padding:2px 6px; border-radius:6px; }
    .qrWrap { display:flex; justify-content:center; padding:10px; }
    #qrcode canvas, #qrcode img { max-width: 260px; }
    table { width:100%; border-collapse: collapse; }
    td { padding:6px 0; vertical-align: top; }
    td:first-child { font-weight: 700; width: 160px; }
    .rowBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  </style>

  <!-- Esc√°ner QR (c√°mara) -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Generador QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>

<body>
  <h1>üì¶ QR de Producto: Generar y Escanear</h1>
  <p class="muted">
    Funciona en GitHub Pages (HTTPS). Los datos se guardan en este navegador (localStorage).
  </p>

  <div class="tabs">
    <button class="tab active" id="tabGen">üßæ Generar QR</button>
    <button class="tab" id="tabScan">üì∑ Escanear QR</button>
    <button class="tab" id="tabLista">üìã Lista</button>
  </div>

  <!-- GENERAR -->
  <section id="viewGen" class="grid">
    <div class="card">
      <h2>1) Llenar datos del producto</h2>
      <form id="formGen">
        <label for="producto">Producto</label>
        <input id="producto" required placeholder="Ej: Pintura blanca 1L" />

        <label for="origen">¬øDe d√≥nde es el producto?</label>
        <input id="origen" required placeholder="Ej: Almac√©n Central / Proveedor X" />

        <label for="funcion">¬øPara qu√© funciona?</label>
        <input id="funcion" required placeholder="Ej: Pintar paredes interiores" />

        <label for="destino">¬øPara d√≥nde va?</label>
        <input id="destino" required placeholder="Ej: Obra A / Casa 12" />

        <label for="nota">Nota (opcional)</label>
        <textarea id="nota" rows="3" placeholder="Lote, color, observaciones..."></textarea>

        <div class="rowBtns">
          <button type="submit" class="btn">Guardar y generar QR</button>
          <button type="button" class="btn3" id="limpiarGen">Limpiar</button>
        </div>
      </form>

      <div id="genMsg" style="margin-top:12px;"></div>
    </div>

    <div class="card">
      <h2>2) QR generado</h2>
      <p><b>ID del producto:</b> <code id="idGenerado">‚Äî</code></p>
      <div class="qrWrap"><div id="qrcode"></div></div>

      <div class="warn">
        Tip: Puedes imprimir esta pantalla o hacer captura.  
        El QR contiene el ID; al escanearlo se ven los datos.
      </div>

      <div class="rowBtns">
        <button class="btn2" id="copiarId" disabled>Copiar ID</button>
        <button class="btn3" id="abrirVistaScan">Ir a escanear</button>
      </div>
    </div>
  </section>

  <!-- ESCANEAR -->
  <section id="viewScan" class="grid" style="display:none;">
    <div class="card">
      <h2>Escanear QR</h2>
      <p class="muted">Dale permisos a la c√°mara.</p>

      <div id="reader" style="width:100%;"></div>

      <div class="rowBtns">
        <button class="btn3" id="startBtn">Iniciar c√°mara</button>
        <button class="btn3" id="stopBtn" disabled>Detener</button>
      </div>

      <p class="muted" id="scanMsg"></p>
      <p><b>ID escaneado:</b> <code id="idEscaneado">‚Äî</code></p>
    </div>

    <div class="card">
      <h2>Datos del producto</h2>
      <div id="datosBox" class="warn">Escanea un QR para ver los datos.</div>

      <div class="rowBtns">
        <button class="btn" id="marcarRecibido" disabled>‚úÖ Marcar como recibido</button>
        <button class="btn3" id="borrarRegistro" disabled>üóëÔ∏è Borrar registro</button>
      </div>
    </div>
  </section>

  <!-- LISTA -->
  <section id="viewLista" style="display:none;">
    <div class="card">
      <h2>Registros guardados (este dispositivo)</h2>
      <div class="rowBtns">
        <button class="btn3" id="refrescar">Refrescar</button>
        <button class="btn3" id="borrarTodo">Borrar todo</button>
      </div>
      <div id="lista" style="margin-top:12px;"></div>
      <p class="muted">
        Nota: Si quieres que esto funcione para TODOS (varios celulares), hay que guardar en nube (Google Sheets/Firebase).
      </p>
    </div>
  </section>

<script>
  // ====== Helpers ======
  const $ = (id) => document.getElementById(id);
  const key = (id) => "prod:" + id;

  function nowISO(){ return new Date().toISOString(); }

  function newId(){
    // ID corto √∫nico: fecha + random
    return "P" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 7);
  }

  function escapeHTML(str) {
    return (str || "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setBox(el, type, html){
    el.className = type;
    el.innerHTML = html;
  }

  // ====== Tabs ======
  function show(view){
    $("viewGen").style.display = view === "gen" ? "" : "none";
    $("viewScan").style.display = view === "scan" ? "" : "none";
    $("viewLista").style.display = view === "lista" ? "" : "none";

    $("tabGen").classList.toggle("active", view === "gen");
    $("tabScan").classList.toggle("active", view === "scan");
    $("tabLista").classList.toggle("active", view === "lista");
  }

  $("tabGen").onclick = () => show("gen");
  $("tabScan").onclick = () => show("scan");
  $("tabLista").onclick = () => { show("lista"); renderList(); };

  $("abrirVistaScan").onclick = () => show("scan");

  // ====== QR Generate ======
  let qrObj = null;

  function renderQR(text){
    const target = $("qrcode");
    target.innerHTML = "";
    qrObj = new QRCode(target, {
      text,
      width: 260,
      height: 260
    });
  }

  $("formGen").addEventListener("submit", (e) => {
    e.preventDefault();

    const record = {
      id: newId(),
      producto: $("producto").value.trim(),
      origen: $("origen").value.trim(),
      funcion: $("funcion").value.trim(),
      destino: $("destino").value.trim(),
      nota: $("nota").value.trim(),
      creado_en: nowISO(),
      recibido: false,
      recibido_en: null
    };

    if(!record.producto || !record.origen || !record.funcion || !record.destino){
      setBox($("genMsg"), "err", "‚ùå Completa producto, origen, funci√≥n y destino.");
      return;
    }

    localStorage.setItem(key(record.id), JSON.stringify(record));

    $("idGenerado").textContent = record.id;
    renderQR(record.id);

    $("copiarId").disabled = false;
    setBox($("genMsg"), "ok", `‚úÖ Guardado. QR generado para ID: <code>${record.id}</code>`);
    renderList();
  });

  $("limpiarGen").onclick = () => {
    $("producto").value = "";
    $("origen").value = "";
    $("funcion").value = "";
    $("destino").value = "";
    $("nota").value = "";
    $("idGenerado").textContent = "‚Äî";
    $("qrcode").innerHTML = "";
    $("copiarId").disabled = true;
    $("genMsg").innerHTML = "";
  };

  $("copiarId").onclick = async () => {
    const id = $("idGenerado").textContent;
    if(!id || id==="‚Äî") return;
    try{
      await navigator.clipboard.writeText(id);
      setBox($("genMsg"), "ok", `üìã ID copiado: <code>${id}</code>`);
    }catch(e){
      setBox($("genMsg"), "warn", `No se pudo copiar autom√°ticamente. Copia manual: <code>${id}</code>`);
    }
  };

  // ====== QR Scan ======
  let html5QrCode = null;

  function showRecordById(id){
    $("idEscaneado").textContent = id;

    const raw = localStorage.getItem(key(id));
    if(!raw){
      setBox($("datosBox"), "err", `‚ùå No existe un registro guardado para ID: <code>${escapeHTML(id)}</code>`);
      $("marcarRecibido").disabled = true;
      $("borrarRegistro").disabled = true;
      return;
    }

    const r = JSON.parse(raw);

    const status = r.recibido
      ? `<div class="ok"><b>Estado:</b> Recibido ‚úÖ<br/><span class="muted">${r.recibido_en}</span></div>`
      : `<div class="warn"><b>Estado:</b> Pendiente ‚è≥</div>`;

    setBox($("datosBox"), "ok", `
      ${status}
      <table>
        <tr><td>ID</td><td><code>${escapeHTML(r.id)}</code></td></tr>
        <tr><td>Producto</td><td>${escapeHTML(r.producto)}</td></tr>
        <tr><td>Origen</td><td>${escapeHTML(r.origen)}</td></tr>
        <tr><td>Funci√≥n</td><td>${escapeHTML(r.funcion)}</td></tr>
        <tr><td>Destino</td><td>${escapeHTML(r.destino)}</td></tr>
        ${r.nota ? `<tr><td>Nota</td><td>${escapeHTML(r.nota)}</td></tr>` : ""}
        <tr><td>Creado</td><td class="muted">${escapeHTML(r.creado_en || "‚Äî")}</td></tr>
      </table>
    `);

    $("marcarRecibido").disabled = r.recibido; // si ya recibido, deshabilita
    $("borrarRegistro").disabled = false;
  }

  function onScanSuccess(decodedText){
    // QR contiene el ID
    showRecordById(decodedText.trim());
  }

  async function startScanner(){
    $("scanMsg").textContent = "Iniciando c√°mara...";
    if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");

    try{
      const cams = await Html5Qrcode.getCameras();
      if(!cams || cams.length===0){
        $("scanMsg").textContent = "No se detectaron c√°maras.";
        return;
      }

      $("startBtn").disabled = true;
      $("stopBtn").disabled = false;

      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
      );

      $("scanMsg").textContent = "C√°mara activa. Enfoca el QR.";
    }catch(err){
      $("scanMsg").textContent = "Error al iniciar c√°mara: " + err;
      $("startBtn").disabled = false;
      $("stopBtn").disabled = true;
    }
  }

  async function stopScanner(){
    if(!html5QrCode) return;
    try{
      await html5QrCode.stop();
      await html5QrCode.clear();
      $("scanMsg").textContent = "C√°mara detenida.";
    }catch(e){}
    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
  }

  $("startBtn").onclick = startScanner;
  $("stopBtn").onclick = stopScanner;

  $("marcarRecibido").onclick = () => {
    const id = $("idEscaneado").textContent;
    if(!id || id==="‚Äî") return;

    const raw = localStorage.getItem(key(id));
    if(!raw) return;

    const r = JSON.parse(raw);
    r.recibido = true;
    r.recibido_en = nowISO();
    localStorage.setItem(key(id), JSON.stringify(r));
    showRecordById(id);
    renderList();
  };

  $("borrarRegistro").onclick = () => {
    const id = $("idEscaneado").textContent;
    if(!id || id==="‚Äî") return;
    if(!confirm("¬øBorrar este registro?")) return;
    localStorage.removeItem(key(id));
    setBox($("datosBox"), "warn", "Registro borrado. Escanea otro QR.");
    $("marcarRecibido").disabled = true;
    $("borrarRegistro").disabled = true;
    renderList();
  };

  // ====== Lista ======
  function renderList(){
    const items = [];
    for(let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if(k && k.startsWith("prod:")){
        items.push(JSON.parse(localStorage.getItem(k)));
      }
    }
    items.sort((a,b)=> (b.creado_en||"").localeCompare(a.creado_en||""));

    const box = $("lista");
    if(items.length===0){
      box.innerHTML = `<p class="muted">No hay registros guardados.</p>`;
      return;
    }

    box.innerHTML = items.map(r => `
      <div class="card" style="margin-top:10px;">
        <b>ID:</b> <code>${escapeHTML(r.id)}</code><br/>
        <b>Producto:</b> ${escapeHTML(r.producto)}<br/>
        <b>Destino:</b> ${escapeHTML(r.destino)}<br/>
        <b>Estado:</b> ${r.recibido ? "Recibido ‚úÖ" : "Pendiente ‚è≥"}<br/>
        <span class="muted">${escapeHTML(r.creado_en || "")}</span>
        <div class="rowBtns">
          <button class="btn2" onclick="(function(){ show('scan'); showRecordById('${encodeURIComponent(r.id)}'); })()">Ver</button>
          <button class="btn3" onclick="(function(){ localStorage.removeItem('${"prod:" + r.id}'); renderList(); })()">Borrar</button>
        </div>
      </div>
    `).join("");
  }

  $("refrescar").onclick = renderList;
  $("borrarTodo").onclick = () => {
    if(!confirm("¬øBorrar TODOS los registros de este dispositivo?")) return;
    const keys = [];
    for(let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if(k && k.startsWith("prod:")) keys.push(k);
    }
    keys.forEach(k=>localStorage.removeItem(k));
    renderList();
    alert("Listo, todo borrado.");
  };

  // Init
  renderList();
</script>
</body>
</html>